<html>
	<head>
        <title>DI Radio</title>
        
    	<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link href="/lib/layout/css/bootstrap.css" rel="stylesheet">
	    <style type="text/css">
	      body {
	        padding-top: 60px;
	        padding-bottom: 40px;
	      }
	    </style>
	    <link href="/lib/layout/css/bootstrap-responsive.css" rel="stylesheet">
		<link href="/lib/layout/css/sprite.css" rel="stylesheet">
		<link href="style.css" rel="stylesheet" type="text/css"/>
		
        <script type="text/javascript" src="lib/air/AIRAliases.js"></script>
		<script type="text/javascript" src="lib/jquery/jquery-1.4.2.min.js"></script>
		<script type="text/javascript" src="lib/js/tray.js"></script>
		<script src="lib/js/notification.js"></script>
        <script type="text/javascript">
			var radioList;
			var player;
			var s;
			
			s = "";
			
			function watch(obj, prop, handler) { // make this a framework/global function
			    var currval = obj[prop];
			    function callback() {
			        if (obj[prop] != currval) {
			            var temp = currval;
			            currval = obj[prop];
			            handler(temp, currval);
			        }
			    }
			    return callback;
			}		
			
			var myhandler = function (oldval, newval) {
			    var id3 = newval; 
			 
			    air.trace("Received ID3 Info:"); 
			    for (propName in id3) 
			    { 
			        air.trace(propName + " = " + id3[propName]); 
			    } 
			};

            function plsToStream(station,url,number) {
				air.trace("plsToStream: " + station + ", " + url + ", " + number);
				var regex = new RegExp("File" + number + ".*");
				
				url = url.toString();
								
				var reqStream = new XMLHttpRequest();
				reqStream.onreadystatechange = function(){
					air.trace("XMLHTTP: " + reqStream.readyState)
					if (reqStream.readyState == 4 && reqStream.status == 200) {
						if (reqStream.responseText.length > 0) {
							var stream = regex.exec(reqStream.responseText);
							
							if (stream === null) {
								alert("Error: Channel not found.")
								return false;
							}
							
							stream = stream.toString();
							stream = stream.replace(/File[0-9]{1,3}=/, "");
							
							try {
								player.stop();
								s.close()
							} 
							catch (err) {
								air.trace("Stopping stream: " + err)
							}
							
							try {
								air.trace(stream);
								s = new air.Sound();
								var request = new air.URLRequest(stream);
								var context = new air.SoundLoaderContext(8000, true);
								s.addEventListener(air.Event.ID3, onID3InfoReceived); 
								s.load(request, context);			
								player = s.play();
								trayIcon.tooltip = "DI Radio - " + station;
								notify("DI Radio",station)
								document.getElementById("station").innerHTML = station;
								document.getElementById("none").style.display = "none";
								document.getElementById("np").style.display = "inline";
								setTimeout(function(){
									air.trace("Bytes loaded: " + s.bytesLoaded);
									var intervalH = setInterval(watch(s, "ID3", myhandler), 100);
									if (s.bytesLoaded < 8000) {
										air.trace("Error: Server unavailable");
										var incNumber = number + 1;
										plsToStream(station, url, incNumber);
									}
								}, 5000);
							} 
							catch (err) {
								air.trace("Error: " + err);
								var incNumber = number + 1;
								plsToStream(station, url, incNumber);
							}
						}
						else {
							alert("Error: Could not find playlist.")
							air.trace("Errorcode: " + reqStream.status)
						}
					}
				};
				reqStream.open('GET', url, false);
				reqStream.send(null);	
			}
			
			function onID3InfoReceived(event) { 
			    var id3 = event.target.id3; 
			 
			    air.trace("Received ID3 Info:"); 
			    for (propName in id3) 
			    { 
			        air.trace(propName + " = " + id3[propName]); 
			    } 
			}
			
			function radioToPls(radio) {
				for ( x in radioList) {
					if ( radioList[x].name == radio ) return radioList[x].playlist;
				}
			}
			
			function getRadio() {				
				var req = new XMLHttpRequest();
				req.onreadystatechange = function(){
					if (req.readyState == 4 && req.status == 200) {
						if (req.responseText.length > 0) {
							radioList = jQuery.parseJSON(req.responseText);
							document.getElementById("channellist").innerHTML = "";
							
							for ( x in radioList ) {
								var name = radioList[x].key;
								document.getElementById("channellist").innerHTML += '<li><a id="' + radioList[x].key + '" href="go.html">' + radioList[x].name + '</a></li>';
							}	
							
							for ( x in radioList ) {
								document.getElementById(radioList[x].key).onclick = function() { channelToRadio(this.innerHTML) } 
							}	
							
						}
						else alert("Error: Could not find channel list.")
					}
				};
				req.open('GET', 'http://listen.di.fm/public3', true);
				req.send(null);	
			}
			
			function channelToRadio(radio) {
				air.trace("channelToRadio: " + radio); 
				air.trace("radioToPls: " + radioToPls(radio))
				plsToStream(radio, radioToPls(radio), 1);
			}
			
			function init() {
				getRadio();
			}
			
			function stopPlayer() {
				air.trace('Stopping Stream...'); 
				player.stop(); 
				s.close();
				document.getElementById("none").style.display = 'inline';
				document.getElementById("np").style.display = 'none';
			}
        </script>
	</head>

    <body onload="init();">
   		<div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
			<span class="icon-bar"></span>
          </a>
          <a class="brand" href="/">DI Radio Player</a>
          <div class="nav-collapse">
            <ul class="nav">
				<li><a href="DIRadio.html">Player</a></li>
				<li><a href="config.html">Configuration</a></li>		
            </ul>
          </div>
        </div>
      </div>
    </div>
		
        <div class="container" id="wrap">  
			<h3>DI Radio Stations</h3>
			<ul id="channellist">
				<li>Loading...</li>
			</ul>
        </div>
		
		<div id="player">
			<div id="none">Click on a channel to play</div>
			<div id="np" style="display: none;">NP: DI Radio - <span id="station"></span><br />
			<i class="icon-play"></i><a onclick="stopPlayer();"><i class="icon-stop"></i></a></div>
		</div>
		
		<script src="/lib/layout/js/jquery.js"></script>
    	<script src="/lib/layout/js/bootstrap.min.js"></script>
    </body>
</html>